# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
# This workflow will build a Java project with Gradle and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-gradle

name: Java CI with Gradle

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  test:
#    this is first step in the GHA
    name: Test Repository
    runs-on: ubuntu-latest
    permissions:
      contents: write
#    container: ubuntu:latest
    steps:
    - run: echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
    - run: echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"
    - name: Check out repository code
      uses: actions/checkout@v3
    - name: List current directory
      run: |
        pwd
    - run: echo "üí° The ${{ github.repository }} repository has been cloned to the runner."
    - name: List files in the repository ${{ github.workspace }}
      run: |
        ls -la ${{ github.workspace }}
    - name: Github Tag Bump
#      if: github.event.pull_request.merged
      id: tag_version
      uses: anothrNick/github-tag-action@1.64.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#      with:
#        github_token: ${{ secrets.GITHUB_TOKEN }}
#        tag_prefix: ${{ inputs.app_tag_prefix }}
    - run: echo Tag Bump ${{ steps.tag_version.outputs.new_tag }}
      shell: bash
    - name: Prepare version
      uses: ./.github/actions/prepare-version
      with:
        release: ${{ github.event.pull_request.merged }}
        tag: ${{ steps.tag_version.outputs.new_tag }}
      id: prepare_version
    - run: echo Publishing version ${{ steps.prepare_version.outputs.version }}
      shell: bash

#    - name: Create Docker Image and push to a Docker Registry
#      uses: ./.github/actions/publish-docker
#      with:
#        build_directory: ${{ inputs.working_directory }}
#        host: ${{ vars.NEXUS_HOST }}
#        image_tag: ${{ vars.NEXUS_DOCKER_REGISTRY }}/${{ inputs.app_name }}:${{ steps.prepare_version.outputs.version }}
#        username: ${{ vars.NEXUS_SVC_USERNAME }}
#        password: ${{ secrets.NEXUS_SVC_PASSWORD }}
#      env:
#        NEXUS_USR: ${{ vars.NEXUS_USER }}
#        NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
#        GRADLE_S3_REPO_AWS_KEY: ${{ secrets.GRADLE_S3_REPO_AWS_KEY }}
#        GRADLE_S3_REPO_AWS_SECRET_KEY: ${{ secrets.GRADLE_S3_REPO_AWS_SECRET_KEY }}
#    - name: Create Github release
#      if: github.event.pull_request.merged
#      uses: actions/create-release@v1
#      env:
#        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#      with:
#        tag_name: ${{ steps.prepare_version.outputs.version }}
#        release_name: ${{ steps.prepare_version.outputs.version }}
#        body: |
#          ${{ steps.tag_version.outputs.change_log }}
#        draft: true
#        prerelease: false
  build:
    #    this is second step in the GHA
    name: Generic CI
    uses: ./.github/workflows/generic-ci-job.yaml

